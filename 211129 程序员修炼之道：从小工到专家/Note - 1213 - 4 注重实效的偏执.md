# Progmatic Paranoia 

## You can't Write Prefect Software

把它视为生活的公理，接受它，拥抱它，庆祝它。因为完美的软件不存在。



> 当每个人都确实要对你不利时，偏执就是一个好主意————Woody Allen

## 21 按合约设计（DBC）

> 没有什么比常识和坦率更让人感到惊讶。——拉尔夫·沃尔多·爱默生，《散文集》



确保坦率的最佳方案之一就是合约。

合约既规定你的权力与责任，也规定对方的权力与责任

### DBC

> 这是一种简单而强大的技术，它关注的是用文档记载（并约定）软件模块的权力与责任，以确保程序正确性。
>
> 什么是正确的程序？不多不少，做它声明要做的事情的程序。
>
> 用文档记载这样的声明，并进行校验，是**按合约设计（简称DBC）**的核心所在



Bestrand Meyer如何描述软件系统中每一个做某件事情的函数和方法所可能的期望和陈述系统结束时的状态？

* 前条件（precondition）：为了调用例程，必须为真的条件；例程的需求
  * 前条件违反时，例程决不应被调用
* 后条件（postcondition）：例程保证会做的事情，例程完成时世界的状态
  * 例程存在后条件意味着：不允许有无限循环
* 类不变项（class invariant）：类确保从调用者的视角来看，该条件总是为真。



#### DBC与常量参数

> 如果任何以方没有履行合约的条款，（先前约定的）某种补偿措施就会启用————例如，引发异常或是终止程序。
>
> **不管发生什么，不要误以为没能履行合约是bug。**
>
> 它不是某种决不应该发生的事情，这也就是为什么前条件不应被用于完成像用户输入验证这样的任务的原因。



#### Design with Contracts 通过合约进行设计

> 这里强调的重点是在”懒惰“的代码上；
>
> **对在开始之前接受的东西要严格，而允诺返回的东西要尽可能少。**



> 继承和多态是面向对象语言的基石，是合约可以真正闪耀的领域

#### 实现DBC

> 使用DBC的最大好处也许是它迫使需求与保证的问题走到前台来。
>
> 在设计时简单地列举输入域地范围是什么、边界条件是什么、例程允诺交付什么，————或者，更重要的，它不允诺交付什么，————是向着编写更好的软件地一次飞跃。

* 断言：不能用断言做DBC能做的每一件事情
* 语言支持：内建DBC支持的语言
* DBC与早崩溃：通过早崩溃、在问题现场找到和诊断问题要容易得多。

###### 不变项的其他用法

* 循环不变项
* 语义不变项
* 动态合约与代理

> 循环不变项是对循环的最终目标的陈述，但又进行了一般化，这样在循环执行之前和每次循环迭代时，但又进行了一般化，这样在循环执行之前和每次循环迭代时，它都是有效的，你可以把它视为一种**微型合约**



## 22 死程序不说谎

### 要崩溃，不要破坏（trash）

> 尽早检测问题的好处之一时你可以更早崩溃
>
> 而有许多时候，让你的程序崩溃时你的最佳选择。

​	当你的代码发现，某件被认为不可能发生的事情已经发生时，你的程序就不再有存活能力。从此时开始，它所作的任何事情都会变得可疑，所以要尽快终止它。**死程序带来的危害通常比有疾患的程序要小得多。**



## 23 断言式编程

> 在自责中有一种满足感。当我们责备自己时，会觉得再没人有权责备我们。
>
> ​					————奥斯卡·王尔德《多里安·格雷的画像》



一段自我欺骗的Mantra： "这决不会发生......"



## If It Can't Happen,Use Assertions to Ensure That It Won't.

使用断言的注意事项

1. 断言可能会在编译时被关闭————决不要把必须执行的代码放在assert中
2. 不要用断言代替真正的错误处理。断言检查的是决不应该发生的事情
3. 让断言开着



## 24 何时使用异常

### 什么是异常情况

> 异常很少应作为程序的正常流程的一部分使用；异常应保留给意外事件。
>
> 假定某个未被抓住的异常会终止你的程序，问问你自己：
>
> ”如果我移走所有的异常处理器，这些代码是否仍然能运行？“
>
> 如果答案是“否”，那么异常也许就正在被用在非异常的情形中。

### Use Exceptions for Exceptional Problems

> 异常表示即时的、非局部的控制转移————这是一种级联的（cascading）goto

### 使用错误处理器

​	错误处理器是检测到错误时调用的例程。

## 25 怎样配平资源

> “我把你带进这个世界，”我的父亲会说：“我也可以把你赶出去。那没有我影响。我要再造另一个你。
>
> ———— Bill Cosby，Fatherhood

### Finish What you started

> 分配某项资源的例程或对象应该负责解除该资源的分配。



### 嵌套的分配

对于一次需要不只一个资源的例程，可以对资源分配的基本模式进行扩展。有另外的两个建议

1. 以与资源分配的次序相反的次序解除资源的分配
2. 在代码的不同地方分配同一组资源时，总是以相同的次序分配它们。

## 练习题

Q：有些Java开发者故意在使用完某个对象之后，把该对象变量设为NULL，这为什么是个好主意？

A：通过把引用设置为NULL，你使指向被引用对象的指针数目减一。一旦此计数达到零，对象就会符合垃圾收集的条件。把引用设置为NULL对长期运行的程序可能会有重要意义，在这样的程序里，程序员需要确保内存使用不会随时间而增长。